IF DB_ID('0107') IS NULL
CREATE DATABASE [0107];

------------------------------------------------------------------------------------------------------------------

use[0107]
IF OBJECT_ID('学生', 'U') IS NOT NULL
    DROP TABLE 学生;
IF OBJECT_ID('课程', 'U') IS NOT NULL
    DROP TABLE 课程;
IF OBJECT_ID('选修', 'U') IS NOT NULL
    DROP TABLE 选修;

CREATE TABLE 学生 (
    sno CHAR(4) PRIMARY KEY,
    sname VARCHAR(50) NOT NULL UNIQUE,
    age INT,
    sex CHAR(2) NOT NULL DEFAULT '男'
);

CREATE TABLE 课程 (
    cno CHAR(4) PRIMARY KEY,
    cname VARCHAR(50),
    cpno CHAR(4),
    ccredit INT,
    CONSTRAINT fk_cpno FOREIGN KEY (cpno) REFERENCES 课程(cno)
);

CREATE TABLE 选修 (
    sno CHAR(4),
    cno CHAR(4),
    grade INT CHECK (grade BETWEEN 0 AND 100),
    PRIMARY KEY (sno, cno),
    FOREIGN KEY (sno) REFERENCES 学生(sno),
    FOREIGN KEY (cno) REFERENCES 课程(cno)
);


IF EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[v_sc]'))
    DROP VIEW [dbo].[v_sc];
GO
CREATE VIEW [dbo].[v_sc] AS
SELECT 学生.sno, 学生.sname, 课程.cname, 选修.grade
FROM 学生
JOIN 选修 ON 学生.sno = 选修.sno
JOIN 课程 ON 选修.cno = 课程.cno;
GO

------------------------------------------------------------------------------------------------------------------
use [0107]
ALTER TABLE 学生
ADD addr NVARCHAR(100);

INSERT INTO 学生 (sno, sname, age, sex, addr) VALUES 
('0101', '孙文月',20, '女', '地址1'),
('0102', '徐亚飞',25, '女', '地址2'),
('0103', '李冰楠',20, '女', '地址3'),
('0104', '高清芸',16, '女', '地址4'),
('0105', '杜芊睿',18, '女', '地址5'),
('0106', '朱雯雯',18, '女', '地址6'),
('0107', '孙琪轩',19, '男', '地址7'),
('0108', '李赫',20, '男', '地址8'),
('0109', '刘芯伍',25, '男', '地址9'),
('0111', '保昱成',25, '男', '地址10'),
('0112', '王志强',22, '男', '地址11'),
('0113', '刘贤',21, '男', '地址12'),
('0114', '张家铭',20, '男', '地址13'),
('0115', '辛宏远',23, '男', '地址14'),
('0116', '杨泰铭',24, '男', '地址15'),
('0117', '任广文',25, '男', '地址16'),
('0118', '任俊皓',24, '男', '地址17'),
('0119', '王祉懿',24, '男', '地址18'),
('0120', '崔跃坤',23, '男', '地址19'),
('0121', '迟博文',25, '男', '地址20'),
('0122', '吴平泽',19, '男', '地址21'),
('0123', '杨树强',18, '男', '地址22'),
('0124', '徐梓骏',22, '男', '地址23'),
('0125', '徐佳聪',15, '男', '地址24'),
('0127', '徐浩楠',21, '男', '地址25'),
('0128', '张云天',18, '男', '地址26'),
('0129', '王德帅',15, '男', '地址27'),
('0130', '肖绍杰',19, '男', '地址28'),
('0131', '刘德金',16, '男', '地址29'),
('0132', '张柏航',15, '男', '地址30'),
('0133', '谢弘',17, '男', '地址31'),
('0134', '李思序',17, '男', '地址32'),
('0135', '王杰',23, '男', '地址33');




INSERT INTO 课程 (cno, cname, ccredit) VALUES 
('0001', '高等数学', 4),
('0002', '体育', 2),
('0003', '数据库', 2),
('0004', '人文社科', 3);

INSERT INTO 选修 (sno, cno, grade) VALUES 
('0101', '0001', 95),
('0101', '0002', 9),
('0101', '0003', 5),
('0101', '0004', 25),

('0102', '0001', 95),
('0102', '0002', 15),
('0102', '0003', 78),
('0102', '0004', 56),

('0103', '0001', 95),
('0103', '0002', 9),
('0103', '0003', 5),
('0103', '0004', 25),

('0107', '0001', 95),
('0107', '0002', 15),
('0107', '0004', 56),

('0109', '0001',39),
('0111', '0001',66),
('0112', '0002',34),
('0113', '0002',100),
('0114', '0002',28),
('0115', '0002',19),
('0116', '0001',57),
('0117', '0002',93),
('0118', '0002',77),
('0119', '0002',55),
('0120', '0001',100),
('0121', '0002',51),
('0122', '0002',55),
('0123', '0001',43),
('0124', '0002',99),
('0125', '0001',24),
('0127', '0001',38),
('0128', '0001',53),
('0129', '0002',28),
('0130', '0002',16),
('0131', '0001',63),
('0132', '0002',30),
('0133', '0001',45),
('0134', '0001',67),
('0135', '0002',70),

('0108', '0001', 95),
('0108', '0002', 15)
;

------------------------------------------------------------------------------------------------------------------

UPDATE 学生
SET addr = '新地址'
WHERE sno = '0101';

DELETE FROM 选修
WHERE sno = '0101' AND cno = '0001';

------------------------------------------------------------------------------------------------------------------

IF EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[v_sc]'))
    DROP VIEW [dbo].[v_sc];
GO

CREATE VIEW [dbo].[v_sc] AS
SELECT 学生.sno, 学生.sname, 课程.cname, 选修.grade
FROM 学生
JOIN 选修 ON 学生.sno = 选修.sno
JOIN 课程 ON 选修.cno = 课程.cno;
GO

use [0107]
 --2.1 查询2学分的课程名及选修的学生名和成绩
SELECT DISTINCT v_sc.sname
FROM v_sc
WHERE NOT EXISTS (
    
    SELECT 1
    FROM 课程 c
    WHERE c.ccredit = 2
    AND NOT EXISTS (
        
        SELECT 1
        FROM v_sc v2
        WHERE v2.sname = v_sc.sname AND v2.cname = c.cname
    )
);


-- --2.2 检索3学分课程的课程号和课程名
SELECT cno, cname
FROM 课程
WHERE ccredit = 3;

---- 2.3 检索年龄大于23岁的男学生的学号和姓名
SELECT sno, sname
FROM 学生
WHERE age > 23 AND sex = '男';
use [0107]
